---
import { supabase } from '../lib/supabase';
let error = '';
let loading = false;
let user = null;

if (typeof window !== 'undefined') {
  supabase.auth.getUser().then(({ data }) => {
    user = data.user;
    if (user) document.getElementById('logout-btn')?.classList.remove('hidden');
  });
}

async function handleLogin(e) {
  e.preventDefault();
  loading = true;
  error = '';
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const { error: loginError } = await supabase.auth.signInWithPassword({ email, password });
  loading = false;
  if (loginError) {
    error = loginError.message;
    document.getElementById('error-msg').textContent = error;
  } else {
    window.location.href = '/';
  }
}

async function handleLogout() {
  await supabase.auth.signOut();
  window.location.reload();
}
---
<html lang="en">
  <head>
    <title>Login - Der Town</title>
  </head>
  <body>
    <h1>Login</h1>
    <form id="login-form" on:submit={handleLogin}>
      <label for="email">Email:</label>
      <input id="email" type="email" required />
      <br />
      <label for="password">Password:</label>
      <input id="password" type="password" required />
      <br />
      <button type="submit" disabled={loading}>Login</button>
    </form>
    <p id="error-msg" style="color:red;"></p>
    <button id="logout-btn" class="hidden" on:click={handleLogout}>Logout</button>
    <script type="module">
      import { supabase } from '../lib/supabase';
      window.handleLogin = async function(e) {
        e.preventDefault();
        document.getElementById('error-msg').textContent = '';
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          document.getElementById('error-msg').textContent = error.message;
        } else {
          window.location.href = '/';
        }
      };
      window.handleLogout = async function() {
        await supabase.auth.signOut();
        window.location.reload();
      };
      supabase.auth.getUser().then(({ data }) => {
        if (data.user) {
          document.getElementById('logout-btn').classList.remove('hidden');
        }
      });
      document.getElementById('login-form').onsubmit = window.handleLogin;
      document.getElementById('logout-btn').onclick = window.handleLogout;
    </script>
  </body>
</html> 