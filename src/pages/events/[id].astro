---
export const prerender = false;

import Layout from '../../components/Layout.astro';
import Badge from '../../components/ui/Badge.astro';
import ShareButton from '../../components/ui/ShareButton.astro';
import CalendarAddButton from '../../components/ui/CalendarAddButton.astro';
import EditButton from '../../components/ui/EditButton.astro';
import LoginModal from '../../components/ui/LoginModal.astro';
import EditEventModal from '../../components/ui/EditEventModal.astro';
import AddLocationModal from '../../components/ui/AddLocationModal.astro';
import AddOrganizationModal from '../../components/ui/AddOrganizationModal.astro';
import { db } from '../../lib/supabase';
import { getCategoryBadgeVariant, formatEventDateTime } from '../../lib/event-utils';
import { renderMarkdown } from '../../lib/markdown-utils';
import EventListCard from '../../components/EventListCard.astro';
import { checkAdminAccess } from '../../lib/session';
import '../../styles/admin.css';

// Check if user is logged in
const { isAdmin } = await checkAdminAccess(Astro.cookies);

export async function getStaticPaths() {
  // This function is not used when prerender = false, but we keep it for type safety
  return [];
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/events');
}

// Fetch the specific event
const { data: event, error } = await db.events.getById(id);

if (error || !event) {
  return Astro.redirect('/events');
}

// Fetch series events if this event is part of a series
let seriesEvents: Array<{
  id: string;
  title: string;
  start_date: string;
  location?: { name: string };
  primary_tag?: { name: string };
  secondary_tag?: { name: string };
}> = [];

// Check if event has parent_event_id (is a child)
// The event object from getById should include parent_event_id since we select '*'
const parentEventId = (event as any)?.parent_event_id || null;

if (parentEventId) {
  // This event is a child - find all siblings (other events with same parent)
  const { data: seriesData, error: seriesError } = await db.events.getByParentEventId(parentEventId);
  
  if (seriesError) {
    console.error('[Event Details] Error fetching series events:', seriesError);
  }
  
  // Filter to only include current or future events and exclude the current event
  seriesEvents = (seriesData || []).filter((e: any) => {
    if (e.id === id) return false; // Exclude current event
    // Only show future events in the series (or events within the last 14 days)
    const today = new Date();
    today.setDate(today.getDate() - 14); // Allow events from last 14 days
    const cutoffDate = today.toISOString().split('T')[0];
    return e.start_date >= cutoffDate || (e.end_date && e.end_date >= cutoffDate);
  }).sort((a: any, b: any) => {
    // Sort by start_date
    if (!a.start_date) return 1;
    if (!b.start_date) return -1;
    return a.start_date.localeCompare(b.start_date);
  }) as Array<{
    id: string;
    title: string;
    start_date: string;
    location?: { name: string };
    primary_tag?: { name: string };
    secondary_tag?: { name: string };
  }>;
} else {
  // This event might be a parent - find all child events
  const { data: childEvents, error: childError } = await db.events.getByParentEventId(id);
  
  if (childError) {
    console.error('Error fetching child events:', childError);
  }
  
  // Filter to only include current or future events
  seriesEvents = (childEvents || []).filter((e: any) => {
    // Only show future events in the series (or events within the last 14 days)
    const today = new Date();
    today.setDate(today.getDate() - 14); // Allow events from last 14 days
    const cutoffDate = today.toISOString().split('T')[0];
    return e.start_date >= cutoffDate || (e.end_date && e.end_date >= cutoffDate);
  }).sort((a: any, b: any) => {
    // Sort by start_date
    if (!a.start_date) return 1;
    if (!b.start_date) return -1;
    return a.start_date.localeCompare(b.start_date);
  }) as Array<{
    id: string;
    title: string;
    start_date: string;
    location?: { name: string };
    primary_tag?: { name: string };
    secondary_tag?: { name: string };
  }>;
}

// Fetch related events (same organization or location), excluding series events
const { data: relatedEvents } = await db.events.getRelated(id, event.organization_id, event.location_id);

// Filter out series events from related events
const seriesEventIds = new Set(seriesEvents.map(e => e.id));
const related = (relatedEvents || []).filter((e: any) => !seriesEventIds.has(e.id)) as Array<{
  id: string;
  title: string;
  start_date: string;
  location?: { name: string };
}>;
---

<Layout 
  title={`${event.title} - Der Town`}
  description={event.description || `Join us for ${event.title} in Der Town`}
  image={event.external_image_url || '/logo.svg'}
  url={Astro.url.href}
  type="article"
  publishedTime={event.created_at}
  modifiedTime={event.updated_at}
  expirationTime={event.start_date}
  section={event.location?.name}
  tags={[event.primary_tag?.name, event.secondary_tag?.name].filter(Boolean)}
>
  <main class="min-h-screen bg-gradient-blues-bold py-4 sm:py-8">
    <div class="w-full max-w-6xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
      <!-- Event Header -->
      <div class="bg-white rounded-lg shadow-lg mb-6 sm:mb-8 relative">
        {event.external_image_url && (
          <div class="overflow-hidden rounded-t-lg w-full">
            <div class="event-detail-image-wrapper">
              <img src={event.external_image_url} alt={String(event.image_alt_text ?? 'Event image')} class="event-detail-image" />
            </div>
          </div>
        )}
        <div class="p-4 sm:p-6 md:p-8 pb-16 sm:pb-20 relative">
          <!-- Share Button in top-right -->
          <div class="absolute top-4 sm:top-6 right-4 sm:right-6 flex gap-2 z-20">
            {event.id && (
              <EditButton 
                eventId={event.id}
                tooltipText="Edit event"
              />
            )}
            <ShareButton 
              title={event.title || 'Event'}
              url={Astro.url.href}
              tooltipText="Share event with your neighbors"
            />
            <!-- Calendar Add Button -->
            {event.id && event.status !== 'cancelled' && (
              <CalendarAddButton 
                eventId={event.id}
                eventTitle={event.title || 'Event'}
                tooltipText="Add this event to your own calendar"
              />
            )}
          </div>
          <h1 class="text-2xl sm:text-3xl font-bold mb-4 pr-20 sm:pr-24">{event.title || 'Event'}</h1>
          {event.status === 'cancelled' && (
            <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
              This event has been cancelled. Details are kept here in case you bookmarked or shared this page.
            </div>
          )}
          
          <!-- Event Meta -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mt-4 sm:mt-6 h-full">
            <div class="flex flex-col h-full min-h-0">
              <!-- Date/Time -->
              <div class="flex items-center gap-2 text-base sm:text-lg text-gray-700">
                <span class="material-symbols-outlined text-blue-600">calendar_today</span>
                <span class="break-words">{formatEventDateTime(event as any)}</span>
              </div>
              <!-- Location -->
              {event.location?.name && (
                <div class="flex items-start gap-2 text-base sm:text-lg text-gray-700 mt-2">
                  <span class="material-symbols-outlined text-blue-600">location_on</span>
                  {event.location_id ? (
                    <a class="break-words text-blue-600 hover:underline" href={`/locations/${event.location_id}`}>{event.location.name}</a>
                  ) : (
                    <span class="break-words">{event.location.name}</span>
                  )}
                </div>
              )}
              <!-- Organization -->
              {event.organization && (
                <div class="flex items-start gap-2 text-base sm:text-lg text-gray-700 mt-2">
                  <span class="material-symbols-outlined text-blue-600">diversity_3</span>
                  {event.organization_id ? (
                    <a class="break-words text-blue-600 hover:underline" href={`/organizations/${event.organization_id}`}>
                      {typeof event.organization === 'object' && event.organization !== null ? event.organization.name : (event.organization ?? '')}
                    </a>
                  ) : (
                    <span class="break-words">{typeof event.organization === 'object' && event.organization !== null ? event.organization.name : (event.organization ?? '')}</span>
                  )}
                </div>
              )}
              <!-- Website -->
              {event.website && (
                <a href={event.website} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-base sm:text-lg text-blue-600 hover:underline mt-2">
                  <span class="material-symbols-outlined text-blue-600">link</span>
                  <span class="break-words">Website</span>
                </a>
              )}
              <!-- Registration Required -->
              {event.registration && (
                <div class="flex items-center gap-2 text-base sm:text-lg text-orange-600 mt-2">
                  <span class="material-symbols-outlined text-orange-600">local_activity</span>
                  <span class="break-words">Registration required</span>
                </div>
              )}
              <!-- Cost -->
              {event.cost && (
                <div class="flex items-center gap-2 text-base sm:text-lg text-gray-700 mt-2">
                  <span class="material-symbols-outlined text-green-600">attach_money</span>
                  <span class="break-words">{event.cost as string}</span>
                </div>
              )}
            </div>
            <div class="prose max-w-none text-gray-800 sm:text-base" set:html={renderMarkdown(event.description)}></div>
          </div>
          
          <!-- Tags -->
          {(event.primary_tag || event.secondary_tag) && (
            <div class="flex flex-wrap gap-2 mt-6 sm:mt-8">
              {event.primary_tag && (
                <Badge variant={getCategoryBadgeVariant(event.primary_tag.name)} size="md">
                  {event.primary_tag.name}
                </Badge>
              )}
              {event.secondary_tag && (
                <Badge variant={getCategoryBadgeVariant(event.secondary_tag.name)} size="md">
                  {event.secondary_tag.name}
                </Badge>
              )}
            </div>
          )}
          
          <!-- Action Buttons - moved to bottom-right -->
          {event.registration_link && (
            <div class="absolute bottom-4 sm:bottom-6 right-4 sm:right-6">
              <a href={event.registration_link} target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 shadow-lg">
                Register Now
              </a>
            </div>
          )}
        </div>
      </div>
      
      <!-- Series Events (if part of a series) -->
      {seriesEvents.length > 0 && (
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 sm:mb-8">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">Events in This Series</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {seriesEvents.map((seriesEvent) => (
              <EventListCard
                event={seriesEvent}
                tags={{
                  primary: ('primary_tag' in seriesEvent && seriesEvent.primary_tag && typeof seriesEvent.primary_tag === 'object' && 'name' in seriesEvent.primary_tag) ? seriesEvent.primary_tag.name : '',
                  secondary: ('secondary_tag' in seriesEvent && seriesEvent.secondary_tag && typeof seriesEvent.secondary_tag === 'object' && 'name' in seriesEvent.secondary_tag) ? seriesEvent.secondary_tag.name : ''
                }}
              />
            ))}
          </div>
        </div>
      )}
      
      <!-- Related Events -->
      {related.length > 0 && (
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">Related Events</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {related.map((relatedEvent) => (
              <EventListCard
                event={relatedEvent}
                tags={{
                  primary: ('primary_tag' in relatedEvent && relatedEvent.primary_tag && typeof relatedEvent.primary_tag === 'object' && 'name' in relatedEvent.primary_tag) ? relatedEvent.primary_tag.name : '',
                  secondary: ('secondary_tag' in relatedEvent && relatedEvent.secondary_tag && typeof relatedEvent.secondary_tag === 'object' && 'name' in relatedEvent.secondary_tag) ? relatedEvent.secondary_tag.name : ''
                }}
              />
            ))}
          </div>
        </div>
      )}
    </div>
  </main>

  <!-- Pass isAdmin to client via data attribute -->
  <div id="admin-status" data-is-admin={isAdmin} style="display: none;"></div>

  <!-- Login Modal -->
  {event.id && (
    <LoginModal 
      title="Login to Edit Event"
      description="Please log in to edit this event directly."
      editEventId={event.id}
    />
  )}

  {isAdmin && (
    <>
      <EditEventModal />
      <AddLocationModal />
      <AddOrganizationModal />
    </>
  )}

  <!-- Suggest Edit Event Form (for non-logged-in users) -->
  <div id="suggestEditEventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Suggest Event Changes</h3>
      <p style="margin-bottom: 1.5rem; color: #666;">Help us improve this event by suggesting changes. We'll review your suggestions and update the event if appropriate.</p>
      <form id="suggestEditEventForm">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Name: <span style="color: red;">*</span></label>
          <input type="text" id="suggestName" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Email: <span style="color: red;">*</span></label>
          <input type="email" id="suggestEmail" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Suggested Changes: <span style="color: red;">*</span></label>
          <textarea id="suggestChanges" rows="6" required placeholder="Please describe what should be changed and why..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>
        <div id="suggestEditEventMessage" style="margin-bottom: 1rem; display: none;"></div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" onclick="closeSuggestEditEventModal()" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button type="button" onclick="goToLogin()" style="background: #2196f3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <span class="material-symbols-outlined" style="font-size: 1.2rem;">login</span>
            Login to Edit Directly
          </button>
          <button type="submit" style="background: #4caf50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Submit Suggestion</button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script is:inline>
  // Define goToLogin globally immediately (before DOMContentLoaded)
  // This needs to be inline so it's available for onclick handlers
  window.goToLogin = function() {
    console.log('goToLogin called');
    
    // Close the suggest edit modal first
    var suggestModal = document.getElementById('suggestEditEventModal');
    if (suggestModal) {
      suggestModal.style.display = 'none';
    }
    
    // Try to open login modal, with retry in case script hasn't loaded yet
    var tryOpenModal = function() {
      if (typeof window.openLoginModal === 'function') {
        console.log('Calling openLoginModal');
        window.openLoginModal();
        return true;
      }
      console.log('openLoginModal not found yet');
      return false;
    };
    
    // Try immediately
    if (tryOpenModal()) {
      return;
    }
    
    // If not available, wait a bit and try again (script might still be loading)
    setTimeout(function() {
      if (!tryOpenModal()) {
        console.warn('openLoginModal not available after retry, falling back to redirect');
        // Fallback: redirect to login page
        var currentUrl = window.location.pathname + window.location.search;
        var eventId = window.location.pathname.split('/').pop();
        window.location.href = '/login?redirect=' + encodeURIComponent(`/admin/events/${eventId}`);
      }
    }, 100);
  };
  
  console.log('goToLogin function defined');
</script>

<script>
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Get isAdmin from data attribute
    const isAdminElement = document.getElementById('admin-status');
    const isAdmin = isAdminElement?.getAttribute('data-is-admin') === 'true';
    
    // When admin and ?editEvent=id, open the edit modal on this page instead of redirecting
    const urlParams = new URLSearchParams(window.location.search);
    const editEventIdFromUrl = urlParams.get('editEvent');

    // Make openEditEvent globally accessible
    (window as any).openEditEvent = async function(eventId: string) {
      if (isAdmin) {
        // Open edit modal on top of this page; after save we'll refresh
        (window as any).openEditEventModalOnDetailPage?.(eventId);
      } else {
      // User is not logged in - show suggest edit form
      const modal = document.getElementById('suggestEditEventModal');
      const form = document.getElementById('suggestEditEventForm');
      if (modal) modal.style.display = 'block';
      if (form) form.setAttribute('data-event-id', eventId);
      }
    };
    
    // Share functionality
    (window as any).shareEvent = function() {
      const button = (event as any)?.target?.closest('button');
      if (!button) return;
      const url = button.getAttribute('data-share-url');
      const title = button.getAttribute('data-share-title');
      
      if (navigator.share) {
        navigator.share({
          title: title || 'Event',
          url: url || window.location.href
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url || window.location.href).then(() => {
          // Show a brief notification
          const notification = document.createElement('div');
          notification.textContent = 'Link copied to clipboard!';
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
          `;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 2000);
        });
      }
    };
    
    // Calendar dropdown functionality
    (window as any).toggleCalendarDropdown = function() {
      const dropdown = document.getElementById('calendar-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('hidden');
      }
    };

    (window as any).closeSuggestEditEventModal = function() {
      const modal = document.getElementById('suggestEditEventModal');
      const form = document.getElementById('suggestEditEventForm') as HTMLFormElement;
      const message = document.getElementById('suggestEditEventMessage');
      if (modal) modal.style.display = 'none';
      if (form) form.reset();
      if (message) message.style.display = 'none';
    };

    // Handle suggest edit form submission
    const suggestForm = document.getElementById('suggestEditEventForm');
    if (suggestForm) {
      suggestForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const eventId = form.getAttribute('data-event-id');
        const nameInput = document.getElementById('suggestName') as HTMLInputElement;
        const emailInput = document.getElementById('suggestEmail') as HTMLInputElement;
        const suggestionsInput = document.getElementById('suggestChanges') as HTMLTextAreaElement;
        const messageDiv = document.getElementById('suggestEditEventMessage');
        
        if (!nameInput || !emailInput || !suggestionsInput || !messageDiv) return;
        
        const name = nameInput.value;
        const email = emailInput.value;
        const suggestions = suggestionsInput.value;

        if (!eventId || !name || !email || !suggestions) {
          messageDiv.textContent = 'Please fill in all required fields.';
          messageDiv.style.display = 'block';
          messageDiv.style.color = '#d32f2f';
          messageDiv.style.background = '#ffeaea';
          messageDiv.style.padding = '0.7rem 1rem';
          messageDiv.style.borderRadius = '6px';
          return;
        }

        try {
          const response = await fetch('/api/events/suggest-edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              eventId,
              eventTitle: document.querySelector('h1')?.textContent || 'Event',
              eventUrl: window.location.href,
              name,
              email,
              suggestions
            })
          });

          const data = await response.json();

          if (response.ok) {
            messageDiv.textContent = data.message || 'Thank you for your suggestion!';
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#388e3c';
            messageDiv.style.background = '#e8f5e9';
            messageDiv.style.padding = '0.7rem 1rem';
            messageDiv.style.borderRadius = '6px';
            form.reset();
            setTimeout(() => {
              (window as any).closeSuggestEditEventModal();
            }, 3000);
          } else {
            messageDiv.textContent = data.error || 'Failed to submit suggestion. Please try again.';
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#d32f2f';
            messageDiv.style.background = '#ffeaea';
            messageDiv.style.padding = '0.7rem 1rem';
            messageDiv.style.borderRadius = '6px';
          }
        } catch (error) {
          messageDiv.textContent = 'An error occurred. Please try again.';
          messageDiv.style.display = 'block';
          messageDiv.style.color = '#d32f2f';
          messageDiv.style.background = '#ffeaea';
          messageDiv.style.padding = '0.7rem 1rem';
          messageDiv.style.borderRadius = '6px';
        }
      });
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      const suggestModal = document.getElementById('suggestEditEventModal');
      const editModal = document.getElementById('editEventModal');
      
      if (suggestModal && e.target === suggestModal) {
        (window as any).closeSuggestEditEventModal();
      }
      if (editModal && e.target === editModal) {
        editModal.style.display = 'none';
      }
    });

    // --- Admin: edit event in a modal on this page, refresh on save ---
    if (isAdmin) {
      let refDataLoaded = false;
      let allLocations: { id: string; name?: string }[] = [];
      let allOrganizations: { id: string; name?: string }[] = [];
      let allTags: { id: string; name?: string }[] = [];
      let allParentEvents: { id: string; title?: string; start_date?: string; start_time?: string }[] = [];

      function normalizeUrl(url: string | null) {
        if (!url || url.trim() === '') return null;
        const t = url.trim();
        if (/^https?:\/\//i.test(t)) return t;
        return 'https://' + t;
      }
      function getEventStatusFromForm() {
        const cancelled = (document.getElementById('editEventCancelled') as HTMLInputElement)?.checked;
        if (cancelled) return 'cancelled';
        const draft = (document.getElementById('editEventDraft') as HTMLInputElement)?.checked;
        return draft ? 'pending' : 'approved';
      }
      function syncEventStatusControls() {
        const c = document.getElementById('editEventCancelled') as HTMLInputElement;
        const d = document.getElementById('editEventDraft') as HTMLInputElement;
        if (!c || !d) return;
        if (c.checked) { d.checked = false; d.disabled = true; } else { d.disabled = false; }
      }

      async function loadReferenceData() {
        if (refDataLoaded) return;
        const [locRes, orgRes, tagsRes, parentRes] = await Promise.all([
          fetch('/api/admin/locations', { credentials: 'include' }),
          fetch('/api/admin/organizations', { credentials: 'include' }),
          fetch('/api/admin/tags', { credentials: 'include' }),
          fetch('/api/admin/parent-events', { credentials: 'include' }),
        ]);
        if (locRes.ok) allLocations = await locRes.json();
        if (orgRes.ok) allOrganizations = await orgRes.json();
        if (tagsRes.ok) {
          allTags = await tagsRes.json();
          const primary = document.getElementById('editEventPrimaryTag');
          const secondary = document.getElementById('editEventSecondaryTag');
          if (primary && secondary) {
            allTags.forEach((tag: { id: string; name?: string }) => {
              const o1 = document.createElement('option'); o1.value = tag.id; o1.textContent = tag.name || '';
              const o2 = document.createElement('option'); o2.value = tag.id; o2.textContent = tag.name || '';
              primary.appendChild(o1); secondary.appendChild(o2);
            });
          }
        }
        if (parentRes.ok) allParentEvents = await parentRes.json();
        refDataLoaded = true;
      }

      function setupAc(inputId: string, dropdownId: string, hiddenId: string, dataSource: () => { id: string; [k: string]: any }[], display: (x: any) => string) {
        const input = document.getElementById(inputId) as HTMLInputElement;
        const dropdown = document.getElementById(dropdownId);
        const hidden = document.getElementById(hiddenId) as HTMLInputElement;
        if (!input || !dropdown || !hidden) return;
        const close = () => { dropdown.classList.add('hidden'); dropdown.innerHTML = ''; };
        input.addEventListener('input', () => {
          const q = input.value.toLowerCase().trim();
          hidden.value = '';
          if (!q) { close(); return; }
          const matches = dataSource().filter(i => display(i).toLowerCase().includes(q)).slice(0, 8);
          if (!matches.length) { close(); return; }
          dropdown.innerHTML = '';
          matches.forEach(item => {
            const div = document.createElement('div'); div.className = 'autocomplete-dropdown-item'; div.textContent = display(item);
            div.addEventListener('click', () => { input.value = display(item); hidden.value = item.id; close(); });
            dropdown.appendChild(div);
          });
          dropdown.classList.remove('hidden');
        });
        input.addEventListener('focus', () => { if (input.value.trim()) input.dispatchEvent(new Event('input')); });
        document.addEventListener('click', (e) => { if (!dropdown.contains(e.target as Node) && e.target !== input) close(); });
      }

      function populateForm(event: any) {
        const set = (id: string, val: string) => { const el = document.getElementById(id) as HTMLInputElement | null; if (el) el.value = val || ''; };
        const setCheck = (id: string, val: boolean) => { const el = document.getElementById(id) as HTMLInputElement | null; if (el) el.checked = !!val; };
        document.getElementById('editEventModalTitle')!.textContent = 'Edit Event';
        set('editEventTitle', event.title); set('editEventDescription', event.description); set('editEventStartDate', event.start_date); set('editEventEndDate', event.end_date);
        set('editEventStartTime', event.start_time); set('editEventEndTime', event.end_time); set('editEventEmail', event.email); set('editEventWebsite', event.website);
        set('editEventRegistrationLink', event.registration_link); set('editEventExternalImageUrl', event.external_image_url); set('editEventCost', event.cost);
        set('editEventPrimaryTag', event.primary_tag_id); set('editEventSecondaryTag', event.secondary_tag_id); set('editEventComments', event.comments);
        setCheck('editEventRegistration', event.registration); setCheck('editEventExcludeFromCalendar', event.exclude_from_calendar); setCheck('editEventFeatured', event.featured);
        const isCancelled = event.status === 'cancelled';
        setCheck('editEventCancelled', isCancelled); setCheck('editEventDraft', !isCancelled && (event.status === 'pending' || event.status == null));
        syncEventStatusControls();
        if (event.location_id && event.location) { set('editEventLocationId', event.location_id); (document.getElementById('editEventLocationSearch') as HTMLInputElement).value = event.location.name || ''; }
        else { set('editEventLocationId', ''); (document.getElementById('editEventLocationSearch') as HTMLInputElement).value = ''; }
        if (event.organization_id && event.organization) { set('editEventOrganizationId', event.organization_id); (document.getElementById('editEventOrganizationSearch') as HTMLInputElement).value = event.organization.name || ''; }
        else { set('editEventOrganizationId', ''); (document.getElementById('editEventOrganizationSearch') as HTMLInputElement).value = ''; }
        if (event.parent_event_id) {
          const parent = allParentEvents.find((e: any) => e.id === event.parent_event_id);
          const disp = parent ? `${parent.title || ''}${parent.start_date ? ' - ' + new Date(parent.start_date).toLocaleDateString() : ''}${parent.start_time ? ' ' + parent.start_time.substring(0, 5) : ''}` : '';
          (document.getElementById('editEventParentEventSearch') as HTMLInputElement).value = disp;
          set('editEventParentEventId', event.parent_event_id);
        } else { (document.getElementById('editEventParentEventSearch') as HTMLInputElement).value = ''; set('editEventParentEventId', ''); }
      }

      (window as any).closeEditEventModal = function() {
        const modal = document.getElementById('editEventModal');
        if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
      };

      (window as any).openEditEventModalOnDetailPage = async function(eventId: string) {
        await loadReferenceData();
        const res = await fetch(`/api/admin/events/${eventId}`, { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.event) return;
        const formEl = document.getElementById('editEventForm');
        if (formEl) formEl.setAttribute('data-current-edit-id', eventId);
        populateForm(data.event);
        setupAc('editEventLocationSearch', 'editEventLocationDropdown', 'editEventLocationId', () => allLocations, (l: any) => l.name || '');
        setupAc('editEventOrganizationSearch', 'editEventOrganizationDropdown', 'editEventOrganizationId', () => allOrganizations, (o: any) => o.name || '');
        setupAc('editEventParentEventSearch', 'editEventParentEventDropdown', 'editEventParentEventId', () => allParentEvents, (e: any) =>
          `${e.title || ''}${e.start_date ? ' - ' + new Date(e.start_date).toLocaleDateString() : ''}${e.start_time ? ' ' + e.start_time.substring(0, 5) : ''}`);
        const modal = document.getElementById('editEventModal');
        if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
      };

      (window as any).duplicateCurrentEvent = () => { const id = (document.getElementById('editEventForm') as HTMLFormElement)?.getAttribute('data-current-edit-id'); if (id) window.location.href = `/admin/events/${id}`; };
      (window as any).createSeriesFromCurrentEvent = () => { const id = (document.getElementById('editEventForm') as HTMLFormElement)?.getAttribute('data-current-edit-id'); if (id) window.location.href = `/admin/series?parent=${id}`; };

      const form = document.getElementById('editEventForm');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const eventId = window.location.pathname.split('/').pop();
          if (!eventId) return;
          const primaryTag = (document.getElementById('editEventPrimaryTag') as HTMLSelectElement)?.value;
          if (!primaryTag) { alert('Primary tag is required'); return; }
          const formData = {
            id: eventId,
            title: (document.getElementById('editEventTitle') as HTMLInputElement)?.value,
            description: (document.getElementById('editEventDescription') as HTMLInputElement)?.value,
            start_date: (document.getElementById('editEventStartDate') as HTMLInputElement)?.value,
            end_date: (document.getElementById('editEventEndDate') as HTMLInputElement)?.value || null,
            start_time: (document.getElementById('editEventStartTime') as HTMLInputElement)?.value || null,
            end_time: (document.getElementById('editEventEndTime') as HTMLInputElement)?.value || null,
            email: (document.getElementById('editEventEmail') as HTMLInputElement)?.value || null,
            website: normalizeUrl((document.getElementById('editEventWebsite') as HTMLInputElement)?.value),
            registration_link: normalizeUrl((document.getElementById('editEventRegistrationLink') as HTMLInputElement)?.value),
            external_image_url: normalizeUrl((document.getElementById('editEventExternalImageUrl') as HTMLInputElement)?.value),
            cost: (document.getElementById('editEventCost') as HTMLInputElement)?.value || null,
            primary_tag_id: primaryTag,
            secondary_tag_id: (document.getElementById('editEventSecondaryTag') as HTMLSelectElement)?.value || null,
            location_id: (document.getElementById('editEventLocationId') as HTMLInputElement)?.value || null,
            organization_id: (document.getElementById('editEventOrganizationId') as HTMLInputElement)?.value || null,
            parent_event_id: (document.getElementById('editEventParentEventId') as HTMLInputElement)?.value || null,
            registration: (document.getElementById('editEventRegistration') as HTMLInputElement)?.checked,
            exclude_from_calendar: (document.getElementById('editEventExcludeFromCalendar') as HTMLInputElement)?.checked,
            featured: (document.getElementById('editEventFeatured') as HTMLInputElement)?.checked,
            status: getEventStatusFromForm(),
          };
          try {
            const putRes = await fetch('/api/admin/events', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(formData) });
            if (putRes.ok) {
              (window as any).closeEditEventModal();
              window.location.reload();
            } else {
              const err = await putRes.json().catch(() => ({}));
              alert(err.error || 'Failed to update event');
            }
          } catch (err) {
            alert('Failed to update event');
          }
        });
      }

      const cancelledCheckbox = document.getElementById('editEventCancelled') as HTMLInputElement;
      if (cancelledCheckbox) { cancelledCheckbox.addEventListener('change', syncEventStatusControls); syncEventStatusControls(); }

      if (editEventIdFromUrl) {
        (window as any).openEditEventModalOnDetailPage(editEventIdFromUrl);
        window.history.replaceState({}, '', window.location.pathname + window.location.hash);
      }
    }
  });
</script>

<style>
.event-detail-image-wrapper {
  width: 100%;
  height: 200px;
  overflow: hidden;
  position: relative;
}
.event-detail-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  display: block;
  vertical-align: top;
}
@media (min-width: 640px) {
  .event-detail-image-wrapper {
    height: 280px;
  }
}
@media (min-width: 1024px) {
  .event-detail-image-wrapper {
    height: 350px;
  }
}
</style>
