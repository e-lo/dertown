---
export const prerender = false;

import Layout from '../../components/Layout.astro';
import Badge from '../../components/ui/Badge.astro';
import ShareButton from '../../components/ui/ShareButton.astro';
import CalendarAddButton from '../../components/ui/CalendarAddButton.astro';
import EditButton from '../../components/ui/EditButton.astro';
import LoginModal from '../../components/ui/LoginModal.astro';
import { db } from '../../lib/supabase';
import { getCategoryBadgeVariant, formatEventDateTime } from '../../lib/event-utils';
import { renderMarkdown } from '../../lib/markdown-utils';
import EventListCard from '../../components/EventListCard.astro';
import { checkAdminAccess } from '../../lib/session';

// Check if user is logged in
const { isAdmin } = await checkAdminAccess(Astro.cookies);

export async function getStaticPaths() {
  // This function is not used when prerender = false, but we keep it for type safety
  return [];
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/events');
}

// Fetch the specific event
const { data: event, error } = await db.events.getById(id);

if (error || !event) {
  return Astro.redirect('/events');
}

// Fetch series events if this event is part of a series
let seriesEvents: Array<{
  id: string;
  title: string;
  start_date: string;
  location?: { name: string };
  primary_tag?: { name: string };
  secondary_tag?: { name: string };
}> = [];

// Check if event has parent_event_id (is a child)
// The event object from getById should include parent_event_id since we select '*'
const parentEventId = (event as any)?.parent_event_id || null;

if (parentEventId) {
  // This event is a child - find all siblings (other events with same parent)
  const { data: seriesData, error: seriesError } = await db.events.getByParentEventId(parentEventId);
  
  if (seriesError) {
    console.error('[Event Details] Error fetching series events:', seriesError);
  }
  
  // Filter to only include current or future events and exclude the current event
  seriesEvents = (seriesData || []).filter((e: any) => {
    if (e.id === id) return false; // Exclude current event
    // Only show future events in the series (or events within the last 14 days)
    const today = new Date();
    today.setDate(today.getDate() - 14); // Allow events from last 14 days
    const cutoffDate = today.toISOString().split('T')[0];
    return e.start_date >= cutoffDate || (e.end_date && e.end_date >= cutoffDate);
  }).sort((a: any, b: any) => {
    // Sort by start_date
    if (!a.start_date) return 1;
    if (!b.start_date) return -1;
    return a.start_date.localeCompare(b.start_date);
  }) as Array<{
    id: string;
    title: string;
    start_date: string;
    location?: { name: string };
    primary_tag?: { name: string };
    secondary_tag?: { name: string };
  }>;
} else {
  // This event might be a parent - find all child events
  const { data: childEvents, error: childError } = await db.events.getByParentEventId(id);
  
  if (childError) {
    console.error('Error fetching child events:', childError);
  }
  
  // Filter to only include current or future events
  seriesEvents = (childEvents || []).filter((e: any) => {
    // Only show future events in the series (or events within the last 14 days)
    const today = new Date();
    today.setDate(today.getDate() - 14); // Allow events from last 14 days
    const cutoffDate = today.toISOString().split('T')[0];
    return e.start_date >= cutoffDate || (e.end_date && e.end_date >= cutoffDate);
  }).sort((a: any, b: any) => {
    // Sort by start_date
    if (!a.start_date) return 1;
    if (!b.start_date) return -1;
    return a.start_date.localeCompare(b.start_date);
  }) as Array<{
    id: string;
    title: string;
    start_date: string;
    location?: { name: string };
    primary_tag?: { name: string };
    secondary_tag?: { name: string };
  }>;
}

// Fetch related events (same organization or location), excluding series events
const { data: relatedEvents } = await db.events.getRelated(id, event.organization_id, event.location_id);

// Filter out series events from related events
const seriesEventIds = new Set(seriesEvents.map(e => e.id));
const related = (relatedEvents || []).filter((e: any) => !seriesEventIds.has(e.id)) as Array<{
  id: string;
  title: string;
  start_date: string;
  location?: { name: string };
}>;
---

<Layout 
  title={`${event.title} - Der Town`}
  description={event.description || `Join us for ${event.title} in Der Town`}
  image={event.external_image_url || '/logo.svg'}
  url={Astro.url.href}
  type="article"
  publishedTime={event.created_at}
  modifiedTime={event.updated_at}
  expirationTime={event.start_date}
  section={event.location?.name}
  tags={[event.primary_tag?.name, event.secondary_tag?.name].filter(Boolean)}
>
  <main class="min-h-screen bg-gradient-blues-bold py-4 sm:py-8">
    <div class="w-full max-w-6xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
      <!-- Event Header -->
      <div class="bg-white rounded-lg shadow-lg mb-6 sm:mb-8 relative">
        {event.external_image_url && (
          <div class="overflow-hidden rounded-t-lg w-full">
            <div class="event-detail-image-wrapper">
              <img src={event.external_image_url} alt={String(event.image_alt_text ?? 'Event image')} class="event-detail-image" />
            </div>
          </div>
        )}
        <div class="p-4 sm:p-6 md:p-8 pb-16 sm:pb-20 relative">
          <!-- Share Button in top-right -->
          <div class="absolute top-4 sm:top-6 right-4 sm:right-6 flex gap-2 z-20">
            {event.id && (
              <EditButton 
                eventId={event.id}
                tooltipText="Edit event"
              />
            )}
            <ShareButton 
              title={event.title || 'Event'}
              url={Astro.url.href}
              tooltipText="Share event with your neighbors"
            />
            <!-- Calendar Add Button -->
            {event.id && event.status !== 'cancelled' && (
              <CalendarAddButton 
                eventId={event.id}
                eventTitle={event.title || 'Event'}
                tooltipText="Add this event to your own calendar"
              />
            )}
          </div>
          <h1 class="text-2xl sm:text-3xl font-bold mb-4 pr-20 sm:pr-24">{event.title || 'Event'}</h1>
          {event.status === 'cancelled' && (
            <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
              This event has been cancelled. Details are kept here in case you bookmarked or shared this page.
            </div>
          )}
          
          <!-- Event Meta -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mt-4 sm:mt-6 h-full">
            <div class="flex flex-col h-full min-h-0">
              <!-- Date/Time -->
              <div class="flex items-center gap-2 text-base sm:text-lg text-gray-700">
                <span class="material-symbols-outlined text-blue-600">calendar_today</span>
                <span class="break-words">{formatEventDateTime(event as any)}</span>
              </div>
              <!-- Location -->
              {event.location?.name && (
                <div class="flex items-start gap-2 text-base sm:text-lg text-gray-700 mt-2">
                  <span class="material-symbols-outlined text-blue-600">location_on</span>
                  {event.location_id ? (
                    <a class="break-words text-blue-600 hover:underline" href={`/locations/${event.location_id}`}>{event.location.name}</a>
                  ) : (
                    <span class="break-words">{event.location.name}</span>
                  )}
                </div>
              )}
              <!-- Organization -->
              {event.organization && (
                <div class="flex items-start gap-2 text-base sm:text-lg text-gray-700 mt-2">
                  <span class="material-symbols-outlined text-blue-600">diversity_3</span>
                  {event.organization_id ? (
                    <a class="break-words text-blue-600 hover:underline" href={`/organizations/${event.organization_id}`}>
                      {typeof event.organization === 'object' && event.organization !== null ? event.organization.name : (event.organization ?? '')}
                    </a>
                  ) : (
                    <span class="break-words">{typeof event.organization === 'object' && event.organization !== null ? event.organization.name : (event.organization ?? '')}</span>
                  )}
                </div>
              )}
              <!-- Website -->
              {event.website && (
                <a href={event.website} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-base sm:text-lg text-blue-600 hover:underline mt-2">
                  <span class="material-symbols-outlined text-blue-600">link</span>
                  <span class="break-words">Website</span>
                </a>
              )}
              <!-- Registration Required -->
              {event.registration && (
                <div class="flex items-center gap-2 text-base sm:text-lg text-orange-600 mt-2">
                  <span class="material-symbols-outlined text-orange-600">local_activity</span>
                  <span class="break-words">Registration required</span>
                </div>
              )}
              <!-- Cost -->
              {event.cost && (
                <div class="flex items-center gap-2 text-base sm:text-lg text-gray-700 mt-2">
                  <span class="material-symbols-outlined text-green-600">attach_money</span>
                  <span class="break-words">{event.cost as string}</span>
                </div>
              )}
            </div>
            <div class="prose max-w-none text-gray-800 sm:text-base" set:html={renderMarkdown(event.description)}></div>
          </div>
          
          <!-- Tags -->
          {(event.primary_tag || event.secondary_tag) && (
            <div class="flex flex-wrap gap-2 mt-6 sm:mt-8">
              {event.primary_tag && (
                <Badge variant={getCategoryBadgeVariant(event.primary_tag.name)} size="md">
                  {event.primary_tag.name}
                </Badge>
              )}
              {event.secondary_tag && (
                <Badge variant={getCategoryBadgeVariant(event.secondary_tag.name)} size="md">
                  {event.secondary_tag.name}
                </Badge>
              )}
            </div>
          )}
          
          <!-- Action Buttons - moved to bottom-right -->
          {event.registration_link && (
            <div class="absolute bottom-4 sm:bottom-6 right-4 sm:right-6">
              <a href={event.registration_link} target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 shadow-lg">
                Register Now
              </a>
            </div>
          )}
        </div>
      </div>
      
      <!-- Series Events (if part of a series) -->
      {seriesEvents.length > 0 && (
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8 mb-6 sm:mb-8">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">Events in This Series</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {seriesEvents.map((seriesEvent) => (
              <EventListCard
                event={seriesEvent}
                tags={{
                  primary: ('primary_tag' in seriesEvent && seriesEvent.primary_tag && typeof seriesEvent.primary_tag === 'object' && 'name' in seriesEvent.primary_tag) ? seriesEvent.primary_tag.name : '',
                  secondary: ('secondary_tag' in seriesEvent && seriesEvent.secondary_tag && typeof seriesEvent.secondary_tag === 'object' && 'name' in seriesEvent.secondary_tag) ? seriesEvent.secondary_tag.name : ''
                }}
              />
            ))}
          </div>
        </div>
      )}
      
      <!-- Related Events -->
      {related.length > 0 && (
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-8">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">Related Events</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {related.map((relatedEvent) => (
              <EventListCard
                event={relatedEvent}
                tags={{
                  primary: ('primary_tag' in relatedEvent && relatedEvent.primary_tag && typeof relatedEvent.primary_tag === 'object' && 'name' in relatedEvent.primary_tag) ? relatedEvent.primary_tag.name : '',
                  secondary: ('secondary_tag' in relatedEvent && relatedEvent.secondary_tag && typeof relatedEvent.secondary_tag === 'object' && 'name' in relatedEvent.secondary_tag) ? relatedEvent.secondary_tag.name : ''
                }}
              />
            ))}
          </div>
        </div>
      )}
    </div>
  </main>

  <!-- Pass isAdmin to client via data attribute -->
  <div id="admin-status" data-is-admin={isAdmin} style="display: none;"></div>

  <!-- Login Modal -->
  {event.id && (
    <LoginModal 
      title="Login to Edit Event"
      description="Please log in to edit this event directly."
      editEventId={event.id}
    />
  )}

  <!-- Edit Event Modal (for logged-in users) -->
  <div id="editEventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Edit Event</h3>
      <div id="editEventModalContent">
        <p>Loading...</p>
      </div>
    </div>
  </div>

  <!-- Suggest Edit Event Form (for non-logged-in users) -->
  <div id="suggestEditEventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">Suggest Event Changes</h3>
      <p style="margin-bottom: 1.5rem; color: #666;">Help us improve this event by suggesting changes. We'll review your suggestions and update the event if appropriate.</p>
      <form id="suggestEditEventForm">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Name: <span style="color: red;">*</span></label>
          <input type="text" id="suggestName" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Email: <span style="color: red;">*</span></label>
          <input type="email" id="suggestEmail" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Suggested Changes: <span style="color: red;">*</span></label>
          <textarea id="suggestChanges" rows="6" required placeholder="Please describe what should be changed and why..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>
        <div id="suggestEditEventMessage" style="margin-bottom: 1rem; display: none;"></div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" onclick="closeSuggestEditEventModal()" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button type="button" onclick="goToLogin()" style="background: #2196f3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <span class="material-symbols-outlined" style="font-size: 1.2rem;">login</span>
            Login to Edit Directly
          </button>
          <button type="submit" style="background: #4caf50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Submit Suggestion</button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script is:inline>
  // Define goToLogin globally immediately (before DOMContentLoaded)
  // This needs to be inline so it's available for onclick handlers
  window.goToLogin = function() {
    console.log('goToLogin called');
    
    // Close the suggest edit modal first
    var suggestModal = document.getElementById('suggestEditEventModal');
    if (suggestModal) {
      suggestModal.style.display = 'none';
    }
    
    // Try to open login modal, with retry in case script hasn't loaded yet
    var tryOpenModal = function() {
      if (typeof window.openLoginModal === 'function') {
        console.log('Calling openLoginModal');
        window.openLoginModal();
        return true;
      }
      console.log('openLoginModal not found yet');
      return false;
    };
    
    // Try immediately
    if (tryOpenModal()) {
      return;
    }
    
    // If not available, wait a bit and try again (script might still be loading)
    setTimeout(function() {
      if (!tryOpenModal()) {
        console.warn('openLoginModal not available after retry, falling back to redirect');
        // Fallback: redirect to login page
        var currentUrl = window.location.pathname + window.location.search;
        var eventId = window.location.pathname.split('/').pop();
        window.location.href = '/login?redirect=' + encodeURIComponent(`/admin/events/${eventId}`);
      }
    }, 100);
  };
  
  console.log('goToLogin function defined');
</script>

<script>
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Get isAdmin from data attribute
    const isAdminElement = document.getElementById('admin-status');
    const isAdmin = isAdminElement?.getAttribute('data-is-admin') === 'true';
    
    // Check if we should redirect to admin after login (from URL params)
    const urlParams = new URLSearchParams(window.location.search);
    const editEventId = urlParams.get('editEvent');
    if (editEventId && isAdmin) {
      // User just logged in and wants to edit - redirect to event editor
      window.location.href = `/admin/events/${editEventId}`;
      return; // Don't continue with other initialization
    }
    
    // All calendar functionality is now handled by the CalendarAddButton component
    
    // Make openEditEvent globally accessible
    (window as any).openEditEvent = async function(eventId: string) {
      if (isAdmin) {
        // User is logged in - redirect to admin page with event ID
        window.location.href = `/admin/events/${eventId}`;
      } else {
      // User is not logged in - show suggest edit form
      const modal = document.getElementById('suggestEditEventModal');
      const form = document.getElementById('suggestEditEventForm');
      if (modal) modal.style.display = 'block';
      if (form) form.setAttribute('data-event-id', eventId);
      }
    };
    
    // Share functionality
    (window as any).shareEvent = function() {
      const button = (event as any)?.target?.closest('button');
      if (!button) return;
      const url = button.getAttribute('data-share-url');
      const title = button.getAttribute('data-share-title');
      
      if (navigator.share) {
        navigator.share({
          title: title || 'Event',
          url: url || window.location.href
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url || window.location.href).then(() => {
          // Show a brief notification
          const notification = document.createElement('div');
          notification.textContent = 'Link copied to clipboard!';
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
          `;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 2000);
        });
      }
    };
    
    // Calendar dropdown functionality
    (window as any).toggleCalendarDropdown = function() {
      const dropdown = document.getElementById('calendar-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('hidden');
      }
    };

    (window as any).closeSuggestEditEventModal = function() {
      const modal = document.getElementById('suggestEditEventModal');
      const form = document.getElementById('suggestEditEventForm') as HTMLFormElement;
      const message = document.getElementById('suggestEditEventMessage');
      if (modal) modal.style.display = 'none';
      if (form) form.reset();
      if (message) message.style.display = 'none';
    };

    // Handle suggest edit form submission
    const suggestForm = document.getElementById('suggestEditEventForm');
    if (suggestForm) {
      suggestForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const eventId = form.getAttribute('data-event-id');
        const nameInput = document.getElementById('suggestName') as HTMLInputElement;
        const emailInput = document.getElementById('suggestEmail') as HTMLInputElement;
        const suggestionsInput = document.getElementById('suggestChanges') as HTMLTextAreaElement;
        const messageDiv = document.getElementById('suggestEditEventMessage');
        
        if (!nameInput || !emailInput || !suggestionsInput || !messageDiv) return;
        
        const name = nameInput.value;
        const email = emailInput.value;
        const suggestions = suggestionsInput.value;

        if (!eventId || !name || !email || !suggestions) {
          messageDiv.textContent = 'Please fill in all required fields.';
          messageDiv.style.display = 'block';
          messageDiv.style.color = '#d32f2f';
          messageDiv.style.background = '#ffeaea';
          messageDiv.style.padding = '0.7rem 1rem';
          messageDiv.style.borderRadius = '6px';
          return;
        }

        try {
          const response = await fetch('/api/events/suggest-edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              eventId,
              eventTitle: document.querySelector('h1')?.textContent || 'Event',
              eventUrl: window.location.href,
              name,
              email,
              suggestions
            })
          });

          const data = await response.json();

          if (response.ok) {
            messageDiv.textContent = data.message || 'Thank you for your suggestion!';
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#388e3c';
            messageDiv.style.background = '#e8f5e9';
            messageDiv.style.padding = '0.7rem 1rem';
            messageDiv.style.borderRadius = '6px';
            form.reset();
            setTimeout(() => {
              (window as any).closeSuggestEditEventModal();
            }, 3000);
          } else {
            messageDiv.textContent = data.error || 'Failed to submit suggestion. Please try again.';
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#d32f2f';
            messageDiv.style.background = '#ffeaea';
            messageDiv.style.padding = '0.7rem 1rem';
            messageDiv.style.borderRadius = '6px';
          }
        } catch (error) {
          messageDiv.textContent = 'An error occurred. Please try again.';
          messageDiv.style.display = 'block';
          messageDiv.style.color = '#d32f2f';
          messageDiv.style.background = '#ffeaea';
          messageDiv.style.padding = '0.7rem 1rem';
          messageDiv.style.borderRadius = '6px';
        }
      });
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      const suggestModal = document.getElementById('suggestEditEventModal');
      const editModal = document.getElementById('editEventModal');
      
      if (suggestModal && e.target === suggestModal) {
        (window as any).closeSuggestEditEventModal();
      }
      if (editModal && e.target === editModal) {
        editModal.style.display = 'none';
      }
    });
  });
</script>

<style>
.event-detail-image-wrapper {
  width: 100%;
  height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.event-detail-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  border-radius: 0.5rem 0.5rem 0 0;
}
@media (min-width: 640px) {
  .event-detail-image-wrapper {
    height: 280px;
  }
}
@media (min-width: 1024px) {
  .event-detail-image-wrapper {
    height: 350px;
  }
}
</style>
