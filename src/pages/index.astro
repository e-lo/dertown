---
export const prerender = false;

import Layout from '../components/Layout.astro';
import EventHeroCarousel from '../components/EventHeroCarousel.astro';
import AnnouncementMarquee from '../components/AnnouncementMarquee.astro';
import { db, filterCurrentAndFutureEvents } from '../lib/supabase';

// Fetch all approved events and filter to current/future for carousel
const { data: allEvents, error } = await db.events.getAll();
const events = filterCurrentAndFutureEvents(allEvents || []);

if (error) {
  console.error('Error fetching events:', error);
  if (String(error?.message || '').toLowerCase().includes('fetch failed')) {
    console.error(
      'Supabase unreachable. If using local: run `supabase start` (requires Docker). ' +
      'If using hosted: set PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_KEY in .env or .env.local.'
    );
  }
}

// Fetch published announcements
const { data: announcements, error: announcementsError } = await db.announcements.getPublished();

if (announcementsError) {
  console.error('Error fetching announcements:', announcementsError);
  if (String(announcementsError?.message || '').toLowerCase().includes('fetch failed')) {
    console.error(
      'Supabase unreachable. If using local: run `supabase start` (requires Docker). ' +
      'If using hosted: set PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_KEY in .env or .env.local.'
    );
  }
}
---

<Layout 
  title="Der Town Community Events"
  description="Discover and share community events in Der Town. Connect with neighbors and build community through local events, activities, and announcements."
  image="/logo.svg"
>
  <main class="min-h-screen bg-gradient-to-br from-indigo-600 to-indigo-900 pb-8 md:pb-12">
  <!-- Announcement Marquee -->
    <AnnouncementMarquee announcements={announcements || []} />

  <!-- Hero Section -->
    <section class="relative py-10 md:py-0 pl-4 sm:pl-6 lg:pl-8">
      <div class="w-full md:max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row items-center md:items-center gap-8 md:gap-12 h-full">
          <!-- Hero Text -->
          <div class="flex-1 w-full md:w-1/3 text-center md:text-left text-white px-4 md:px-0">
            <h1 class="text-4xl md:text-6xl font-bold mb-4">
              Welcome to Der Town
            </h1>
            <p class="text-xl max-w-3xl mx-auto md:mx-0">
              Share community.<br>Connect with neighbors.<br>In real life.
            </p>
          </div>
          <!-- Carousel -->
          <div class="flex-1 w-full md:w-2/3 mt-8 md:mt-0">
            <EventHeroCarousel events={events} />
          </div>
        </div>
      </div>
    </section>
  </main>
</Layout>
