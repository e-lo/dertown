---
// Modal to add or edit a location. Used from event form (pop-out) and from admin locations page.
// Dispatches 'admin:location-created' or 'admin:location-updated' with { location } on success.
---

<div id="addLocationModal" class="modal-overlay hidden" style="z-index: 1002;">
  <div class="modal-container" style="max-width: 32rem;">
    <div class="modal-header">
      <h3 id="addLocationModalTitle" class="modal-title">Add Location</h3>
      <button type="button" onclick="window.closeAddLocationModal?.()" class="modal-close-btn" aria-label="Close">
        <span class="material-symbols-outlined text-2xl">close</span>
      </button>
    </div>
    <form id="addLocationForm">
      <input type="hidden" id="addLocationId" value="">
      <div class="form-field">
        <label class="form-label">Name <span class="form-label-required">*</span></label>
        <input type="text" id="addLocationName" required class="form-input-base" placeholder="Location name">
      </div>
      <div class="form-field">
        <label class="form-label">Address</label>
        <input type="text" id="addLocationAddress" class="form-input-base" placeholder="Street address">
      </div>
      <div class="form-grid-2">
        <div class="form-field">
          <label class="form-label">Phone</label>
          <input type="text" id="addLocationPhone" class="form-input-base" placeholder="(555) 123-4567">
        </div>
        <div class="form-field">
          <label class="form-label">Website</label>
          <input type="text" id="addLocationWebsite" class="form-input-base" placeholder="https://...">
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">Parent Location</label>
        <div class="autocomplete-container">
          <input type="text" id="addLocationParentSearch" placeholder="Type to search..." autocomplete="off" class="form-input-base">
          <input type="hidden" id="addLocationParentId" value="">
          <div id="addLocationParentDropdown" class="autocomplete-dropdown hidden"></div>
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">Set location on map (click to set coordinates)</label>
        <div id="addLocationMap" style="height: 220px; width: 100%; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f3f4f6;"></div>
        <p class="text-xs text-gray-500 mt-1">Map is centered on Leavenworth, WA. Click to place the marker.</p>
      </div>
      <div class="form-grid-2">
        <div class="form-field">
          <label class="form-label">Latitude</label>
          <input type="number" id="addLocationLat" step="any" class="form-input-base" placeholder="47.5962">
        </div>
        <div class="form-field">
          <label class="form-label">Longitude</label>
          <input type="number" id="addLocationLon" step="any" class="form-input-base" placeholder="-120.6615">
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">Status</label>
        <select id="addLocationStatus" class="form-input-base">
          <option value="approved">Approved</option>
          <option value="pending">Pending</option>
        </select>
      </div>
      <div class="form-actions">
        <button type="button" onclick="window.closeAddLocationModal?.()" class="btn-cancel">Cancel</button>
        <button type="submit" class="btn-save">Save Location</button>
      </div>
    </form>
  </div>
</div>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
  /* global L */
  (function() {
    const LEAVENWORTH = [47.5962, -120.6615];
    let locationParentList = [];
    let locationMap = null;
    let locationMarker = null;

    const modal = document.getElementById('addLocationModal');
    const form = document.getElementById('addLocationForm');
    const titleEl = document.getElementById('addLocationModalTitle');
    const idInput = document.getElementById('addLocationId');
    const parentSearch = document.getElementById('addLocationParentSearch');
    const parentIdHidden = document.getElementById('addLocationParentId');
    const parentDropdown = document.getElementById('addLocationParentDropdown');
    const latInput = document.getElementById('addLocationLat');
    const lonInput = document.getElementById('addLocationLon');
    const mapEl = document.getElementById('addLocationMap');

    async function loadLocationParentList(excludeId) {
      const res = await fetch('/api/admin/locations?all=true', { credentials: 'include' });
      locationParentList = res.ok ? (await res.json()).filter(loc => loc.id !== excludeId) : [];
    }

    function displayParentLoc(loc) {
      return (loc.name || '') + (loc.address ? ' â€” ' + loc.address : '');
    }

    function setupParentAutocomplete() {
      if (!parentSearch || !parentDropdown || !parentIdHidden) return;
      parentSearch.addEventListener('input', () => {
        const q = parentSearch.value.toLowerCase().trim();
        parentIdHidden.value = '';
        if (!q) {
          parentDropdown.classList.add('hidden');
          parentDropdown.innerHTML = '';
          return;
        }
        const matches = locationParentList.filter(loc =>
          displayParentLoc(loc).toLowerCase().includes(q)
        ).slice(0, 10);
        if (matches.length === 0) {
          parentDropdown.classList.add('hidden');
          parentDropdown.innerHTML = '';
          return;
        }
        parentDropdown.innerHTML = matches.map(loc =>
          '<div class="autocomplete-dropdown-item" data-id="' + loc.id + '" data-label="' + (displayParentLoc(loc).replace(/"/g, '&quot;').replace(/</g, '&lt;')) + '">' + (displayParentLoc(loc).replace(/</g, '&lt;')) + '</div>'
        ).join('');
        parentDropdown.classList.remove('hidden');
        parentDropdown.classList.add('block');
        parentDropdown.querySelectorAll('.autocomplete-dropdown-item').forEach(el => {
          el.addEventListener('click', () => {
            parentIdHidden.value = el.getAttribute('data-id');
            parentSearch.value = el.getAttribute('data-label') || '';
            parentDropdown.classList.add('hidden');
            parentDropdown.innerHTML = '';
          });
        });
      });
      parentSearch.addEventListener('focus', () => { if (parentSearch.value.trim()) parentSearch.dispatchEvent(new Event('input')); });
      document.addEventListener('click', (e) => {
        if (e.target !== parentSearch && !parentDropdown.contains(e.target)) {
          parentDropdown.classList.add('hidden');
        }
      });
    }

    function initMap(lat, lon) {
      if (!mapEl || typeof L === 'undefined') return;
      if (locationMap) {
        locationMap.remove();
        locationMap = null;
        locationMarker = null;
      }
      const hasCoords = lat != null && lon != null && !isNaN(lat) && !isNaN(lon);
      const center = hasCoords ? [Number(lat), Number(lon)] : LEAVENWORTH;
      locationMap = L.map('addLocationMap').setView(center, hasCoords ? 15 : 12);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(locationMap);
      if (hasCoords) {
        locationMarker = L.marker(center).addTo(locationMap);
      }
      locationMap.on('click', (ev) => {
        const { lat: l, lng: lng } = ev.latlng;
        if (locationMarker) locationMarker.setLatLng(ev.latlng);
        else locationMarker = L.marker(ev.latlng).addTo(locationMap);
        if (latInput) latInput.value = Math.round(l * 1e6) / 1e6;
        if (lonInput) lonInput.value = Math.round(lng * 1e6) / 1e6;
      });
    }

    window.openAddLocationModal = async function(editId) {
      if (!modal || !form) return;
      idInput.value = editId || '';
      titleEl.textContent = editId ? 'Edit Location' : 'Add Location';
      form.reset();
      idInput.value = editId || '';
      if (parentIdHidden) parentIdHidden.value = '';
      if (parentSearch) parentSearch.value = '';
      await loadLocationParentList(editId || undefined);

      if (editId) {
        const res = await fetch(`/api/admin/locations/${editId}`, { credentials: 'include' });
        if (!res.ok) return;
        const loc = await res.json();
        document.getElementById('addLocationName').value = loc.name || '';
        document.getElementById('addLocationAddress').value = loc.address || '';
        document.getElementById('addLocationPhone').value = loc.phone || '';
        document.getElementById('addLocationWebsite').value = loc.website || '';
        document.getElementById('addLocationStatus').value = loc.status || 'approved';
        if (loc.parent_location_id) {
          parentIdHidden.value = loc.parent_location_id;
          const parent = locationParentList.find(p => p.id === loc.parent_location_id);
          parentSearch.value = parent ? displayParentLoc(parent) : '';
        }
        if (latInput) latInput.value = loc.latitude ?? '';
        if (lonInput) lonInput.value = loc.longitude ?? '';
        setTimeout(() => initMap(loc.latitude, loc.longitude), 100);
      } else {
        document.getElementById('addLocationStatus').value = 'approved';
        setTimeout(() => initMap(null, null), 100);
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };

    window.closeAddLocationModal = function() {
      if (locationMap) {
        locationMap.remove();
        locationMap = null;
        locationMarker = null;
      }
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    };

    setupParentAutocomplete();

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = idInput.value.trim();
      const payload = {
        name: document.getElementById('addLocationName').value.trim(),
        address: document.getElementById('addLocationAddress').value.trim() || null,
        phone: document.getElementById('addLocationPhone').value.trim() || null,
        website: document.getElementById('addLocationWebsite').value.trim() || null,
        parent_location_id: parentIdHidden?.value || null,
        status: document.getElementById('addLocationStatus').value,
      };
      const lat = latInput?.value;
      const lon = lonInput?.value;
      if (lat !== '' && lon !== '' && lat != null && lon != null) {
        payload.latitude = parseFloat(lat);
        payload.longitude = parseFloat(lon);
      }

      const url = id ? `/api/admin/locations/${id}` : '/api/admin/locations';
      const method = id ? 'PATCH' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.error || 'Failed to save location');
        return;
      }

      const location = await res.json();
      window.closeAddLocationModal();
      if (id) {
        window.dispatchEvent(new CustomEvent('admin:location-updated', { detail: { location } }));
      } else {
        window.dispatchEvent(new CustomEvent('admin:location-created', { detail: { location } }));
      }
    });
  })();
</script>
