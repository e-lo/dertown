---
import { db } from '../lib/supabase';
import { transformEventForCalendar } from '../lib/event-utils';
import { getCategoryBadgeVariant } from '../lib/event-utils';
import { localeTimeZone } from '../lib/calendar-utils';

// Fetch all approved events
// Calendar shows all events (including past events)
const { data: allEvents, error: allEventsError } = await db.events.getAll();
if (allEventsError) {
  console.error('Error fetching events:', allEventsError);
}

// Transform events for FullCalendar - uses transformEventForCalendar which handles UTC conversion
const calendarEvents = (allEvents || [])
  .map((event) => {
    try {
      const transformed = transformEventForCalendar(event);
      if (!transformed) return null;
      
      // Add extended props for FullCalendar
      const fullCalendarEvent = {
        ...transformed,
        extendedProps: {
          description: event.description,
          locationName: event.location?.name || '',
          organizationName: '',
          primaryTag: event.primary_tag?.name || '',
          secondaryTag: event.secondary_tag?.name || '',
          organizationId: event.organization_id,
          locationId: event.location_id,
          bgClass: getCategoryBadgeVariant(event.primary_tag?.name || ''),
        },
      };
      
      return fullCalendarEvent;
    } catch (error) {
      console.warn(`Error processing event ${event.id}:`, error);
      return null;
    }
  })
  .filter(Boolean); // Remove any null events
---

<div id="calendar" data-events={JSON.stringify(calendarEvents)} data-locale-timezone={localeTimeZone}></div>
<script is:inline src="https://unpkg.com/fullcalendar@6.1.11/index.global.min.js"></script>
<script is:inline src="/fullcalendar-init.js"></script> 